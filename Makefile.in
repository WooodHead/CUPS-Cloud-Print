prefix = $(DESTDIR)@prefix@
destdir = $(DESTDIR)
destprefix = @prefix@
srcdir = @srcdir@
INSTALL = @INSTALL@
cupsdriver = ${DESTDIR}@cupsserverpath@/driver/
cupsbackend = ${DESTDIR}@cupsserverpath@/backend/
cupsmodel = ${DESTDIR}@cupsdatapath@/model/
cupsgroup = @cupsgroup@
UNAME_S := $(shell uname -s)
ifneq ($(UNAME_S),Darwin)
prefix = @prefix@/share/
endif

all: backend.py

install: all
	mkdir -p ${prefix}/cloudprint-cups/oauth2client
	mkdir -p ${prefix}/cloudprint-cups/selinux
	mkdir -p ${prefix}/cloudprint-cups/testing/testfiles
	${INSTALL} ${srcdir}/.coveragerc ${prefix}/cloudprint-cups/
	${INSTALL} ${srcdir}/*.py ${prefix}/cloudprint-cups/
	${INSTALL} -m 644 ${srcdir}/ccputils.py ${prefix}/cloudprint-cups/
	${INSTALL} -m 644 ${srcdir}/cloudprintrequestor.py ${prefix}/cloudprint-cups/
	${INSTALL} -m 644 ${srcdir}/printermanager.py ${prefix}/cloudprint-cups/
	${INSTALL} -m 644 ${srcdir}/printer.py ${prefix}/cloudprint-cups/
	${INSTALL} -m 644 ${srcdir}/auth.py ${prefix}/cloudprint-cups/
	${INSTALL} -m 644 ${srcdir}/.coveragerc ${prefix}/cloudprint-cups/
	unlink ${prefix}/cloudprint-cups/pre-commit.py
	${INSTALL} -m 755 ${srcdir}/testing/*.sh ${prefix}/cloudprint-cups/testing/
	${INSTALL} -m 644 ${srcdir}/testing/*.py ${prefix}/cloudprint-cups/testing/
	${INSTALL} -m 755 ${srcdir}/testing/listdrivefiles.py ${prefix}/cloudprint-cups/testing/
	${INSTALL} -m 644 ${srcdir}/testing/testfiles/* ${prefix}/cloudprint-cups/testing/testfiles/
	${INSTALL} -m 644 ${srcdir}/selinux/* ${prefix}/cloudprint-cups/selinux/
	${INSTALL} -m 644 ${srcdir}/oauth2client/*.py ${prefix}/cloudprint-cups/oauth2client/
ifeq ($(UNAME_S),Darwin)
	mkdir -p ${destdir}/Library/LaunchDaemons/
	${INSTALL} -m 644 ${srcdir}/launchd/* ${destdir}/Library/LaunchDaemons/
endif
	mkdir -p ${cupsbackend}
	mkdir -p ${cupsdriver}
	mkdir -p ${cupsmodel}
ifeq ($(NOPERMS),1)
	   ${INSTALL} ${srcdir}/backend.py ${cupsbackend}gcp
	   ${INSTALL} ${srcdir}/dynamicppd.py ${cupsdriver}cupscloudprint
else
	   ${INSTALL} -g `groups root | cut -d' ' -f1` -o root -m 755  ${srcdir}/backend.py ${cupsbackend}gcp
	   ${INSTALL} -g `groups root | cut -d' ' -f1` -o root -m 755  ${srcdir}/dynamicppd.py ${cupsdriver}cupscloudprint
endif
	${INSTALL} -m 644 ${srcdir}/README.md ${prefix}/cloudprint-cups/README.md
	${INSTALL} -m 644 ${srcdir}/COPYING ${prefix}/cloudprint-cups/COPYING
ifneq ($(NOPERMS),1)
	chown -R root:${cupsgroup} ${prefix}/cloudprint-cups/
endif
